import React, { useState, useCallback } from "react";
import logo from "./assets/betrslip-logo.png";
import { apiHealth, apiOcr, apiSuggest, apiParlay } from "./lib/api";

type Leg = { label: string; odds: number; prob?: number };
type PickT = { id: string; label: string; prob: number; odds: number; league?: string };
type Scan = { id: string; name: string; url: string; legs?: Leg[] };
const safePct = (n?: number) => (Number.isFinite(n!) ? `${n!.toFixed(2)}%` : "—");
const safeNum = (n?: number, d = 2) => (Number.isFinite(n!) ? n!.toFixed(d) : "—");
const safeAm  = (n?: number) => (Number.isFinite(n!) ? (n! > 0 ? `+${n}` : `${n}`) : "—");
const impliedProb = (odds: number) => (odds > 0 ? 100 / (odds + 100) : Math.abs(odds) / (Math.abs(odds) + 100));
const Brand = () => (
  <div className="flex items-center gap-3">
    <img src={logo} alt="BetrSlip" className="w-9 h-9 rounded-xl shadow-lg" />
    <div className="font-semibold tracking-wide text-white text-xl">BetrSlip</div>
  </div>
);
const ProviderPills = ({ active, setActive }: { active: string; setActive: (s: string) => void; }) => {
  const items = ["Hard Rock", "DraftKings", "FanDuel"];
  return (
<div className="flex flex-wrap gap-2">
      {items.map((it) => {
        const on = active === it;
        return (
<button
            key={it}
            onClick={() => setActive(it)}
            className={"px-4 py-2 rounded-full text-sm transition " + (on ? "bg-white text-slate-900" : "bg-slate-800 text-slate-200 hover:bg-slate-700")}
          >
            {it}
          </button>
        );
      })}
    </div>
  );
};
const StatTile = ({ label, value }: { label: string; value: React.ReactNode }) => (
  <div className="bg-slate-800/70 rounded-xl p-4">
    <div className="text-xs uppercase tracking-wider text-slate-400">{label}</div>
    <div className="text-2xl font-semibold text-white mt-1">{value}</div>
export default function App() {
  // tabs: home, scans, edge, help
  const [tab, setTab] = useState<"home"|"scans"|"edge"|"help">("home");
  const [busy, setBusy] = useState<null | "health" | "ocr" | "suggest" | "parlay">(null);
  const [err, setErr] = useState<string | null>(null);
  const [legs, setLegs] = useState<Leg[]>([]);
  const [picks, setPicks] = useState<PickT[]>([]);
  const [scans, setScans] = useState<Scan[]>([]);
  const [provider, setProvider] = useState("Hard Rock");
  const [summary, setSummary] = useState<{ winPct?: number; fairDecimal?: number; fairAmerican?: number; kellyPct?: number }>({});
  const addLeg = (l: Leg) => setLegs((xs) => [...xs, l]);
  const rmLeg = (idx: number) => setLegs((xs) => xs.filter((_, i) => i !== idx));
  const clearAll = () => { setLegs([]); setPicks([]); setSummary({}); setErr(null); };
  const onHealth = useCallback(async () => {
    try { setBusy("health"); setErr(null); const ok = await apiHealth(); if (!ok) setErr("API health check failed"); }
    catch (e: any) { setErr(String(e?.message || e)); }
    finally { setBusy(null); }
  }, []);
  const onUpload = useCallback(async (file: File | "stub") => {
    try {
      setBusy("ocr"); setErr(null);
      const res = await apiOcr(file);
      if (res.ok && Array.isArray(res.legs) && res.legs.length) {
        res.legs.forEach((l) => addLeg({ label: l.label || "OCR", odds: Number(l.odds), prob: typeof l.prob === "number" ? l.prob : undefined }));
        // keep a record of the scan (with preview for real files)
        if (file !== "stub" && file instanceof File) {
          const id = crypto.randomUUID();
          const url = URL.createObjectURL(file);
          setScans(xs => [{ id, name: file.name, url, legs: res.legs as Leg[] }, ...xs].slice(0, 25));
        }
      } else {
        setErr("OCR returned no legs" + ("error" in res && res.error ? `: ${res.error}` : ""));
      }
    } catch (e: any) {
      setErr(String(e?.message || e));
    } finally { setBusy(null); }
  const onSuggest = useCallback(async () => {
      setBusy("suggest"); setErr(null);
      const res = await apiSuggest();
      if (res.ok && Array.isArray(res.picks)) setPicks(res.picks);
      else setErr(("error" in res && res.error) ? res.error : "AI suggest returned no picks");
    } catch (e: any) { setErr(String(e?.message || e)); }
  const recompute = useCallback(async (src: Leg[]) => {
      if (!src.length) return setSummary({});
      setBusy("parlay"); setErr(null);
      const res = await apiParlay({ legs: src.map((l) => ({ odds: Number(l.odds) })) });
      if (res.ok) {
        setSummary({
          winPct: Number.isFinite(res.winPercent!) ? res.winPercent : undefined,
          fairDecimal: Number.isFinite(res.fairDecimal!) ? res.fairDecimal : undefined,
          fairAmerican: Number.isFinite(res.fairAmerican!) ? res.fairAmerican : undefined,
          kellyPct: Number.isFinite(res.kelly!) ? res.kelly : undefined,
        });
      } else setErr(res.error || "Parlay compute failed");
  React.useEffect(() => { (async () => { if (legs.length) await recompute(legs); else setSummary({}); })(); }, [legs]); // eslint-disable-line
  // -------- Edge assistant (value ranking) --------
  const rankedPicks = useMemo(() => {
    if (!picks.length) return [];
    return [...picks]
      .map(p => {
        const impl = impliedProb(Number(p.odds));
        const edge = (Number.isFinite(impl) ? p.prob - impl : 0);
        const ev = p.prob * (p.odds > 0 ? p.odds/100 : 100/Math.abs(p.odds)) - (1 - p.prob);
        return { ...p, edge, ev };
      })
      .sort((a,b)=> b.edge - a.edge);
  }, [picks]);
  const buildParlay = (n: number) => {
    const src = rankedPicks.slice(0, n);
    if (!src.length) return;
    src.forEach(p => addLeg({ label: p.label, odds: p.odds, prob: p.prob }));
    setTab("home"); // jump back to betslip
  };
  // ---------- UI blocks ----------
  const UploadBlock = () => (
    <div className="bg-[radial-gradient(1200px_500px_at_-10%_-20%,rgba(124,58,237,.25),transparent)] rounded-3xl p-6 border border-white/5 bg-slate-900/40">
      <div className="text-3xl md:text-4xl font-extrabold tracking-tight text-white">Upload a Screenshot of Your Bet Slip</div>
      <p className="text-slate-400 mt-3">We’ll parse odds and compute a fair price, win % and Kelly stake.</p>
      <div className="mt-5"><ProviderPills active={provider} setActive={setProvider} /></div>
      <div className="mt-6 flex gap-3 items-center">
        {/* Invisible input -> gallery picker (no capture attr) */}
        <input id="imgpick" type="file" accept="image/*" className="hidden"
          onChange={(e) => { const f = e.currentTarget.files?.[0]; if (f) onUpload(f); e.currentTarget.value = ""; }} />
        <button onClick={() => document.getElementById("imgpick")?.click()}
          disabled={busy === "ocr"}
          className="px-5 py-3 rounded-xl bg-violet-600 text-white font-medium hover:bg-violet-500 transition disabled:opacity-60">
        <button onClick={onSuggest} disabled={busy === "suggest"}
          className="px-5 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 font-medium transition">
          {busy === "suggest" ? "Thinking…" : "AI Suggest"}
        <button onClick={clearAll}
          className="px-5 py-3 rounded-xl bg-rose-600/90 hover:bg-rose-500 text-white font-medium transition">
          Clear
      </div>
      {!!err && <div className="mt-4 text-rose-300 text-sm bg-rose-900/30 border border-rose-800/50 rounded-lg p-3">{err}</div>}
  const SummaryBlock = () => (
    <div className="bg-slate-900/40 rounded-3xl border border-white/5 p-6">
      <div className="text-white font-semibold text-lg mb-4">Parlay Summary</div>
      {legs.length === 0 ? (
        <div className="text-slate-400 text-sm">Add legs to see parlay probability.</div>
      ) : (
        <div className="grid grid-cols-2 gap-3">
          <StatTile label="Win %" value={safePct(summary.winPct)} />
          <StatTile label="Fair Decimal" value={safeNum(summary.fairDecimal)} />
          <StatTile label="Fair American" value={safeAm(summary.fairAmerican)} />
          <StatTile label="Kelly %" value={safePct(summary.kellyPct)} />
        </div>
      )}
      {legs.length > 0 && (
        <button onClick={() => recompute(legs)} disabled={busy === "parlay"}
          className="mt-4 w-full px-5 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
          {busy === "parlay" ? "Recomputing…" : "Recompute with API"}
  const BetslipBlock = () => (
      <div className="text-white font-semibold text-lg mb-4">Your Betslip</div>
        <div className="text-slate-400">No legs yet. Upload or Suggest.</div>
        <div className="space-y-3">
          {legs.map((l, i) => (
            <div key={i} className="flex items-center justify-between bg-slate-800/70 rounded-xl p-4">
              <div>
                <div className="text-white font-medium">{l.label}</div>
                <div className="text-slate-400 text-sm">odds {l.odds} {typeof l.prob === "number" ? `• p≈${(l.prob * 100).toFixed(0)}%` : ""}</div>
              </div>
              <button onClick={() => rmLeg(i)} className="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">Remove</button>
            </div>
          ))}
  const AIToolsBlock = () => (
      <div className="text-white font-semibold text-lg mb-4">AI Tools</div>
      {picks.length === 0 ? (
        <div className="text-slate-400">Click AI Suggest to see picks.</div>
          {picks.map((p) => (
            <div key={p.id} className="flex items-center justify-between bg-slate-800/70 rounded-xl p-4">
                <div className="text-white font-medium">
                  {p.label} <span className="text-slate-400">({(p.prob * 100).toFixed(0)}%)</span>
                </div>
                <div className="text-slate-400 text-sm">{p.league || "Mixed"} • odds {p.odds}</div>
              <button onClick={() => addLeg({ label: p.label, odds: p.odds, prob: p.prob })}
                className="px-4 py-2 rounded-lg bg-violet-600 hover:bg-violet-500 text-white font-medium">
                Add to Betslip
              </button>
  // -------- Pages --------
  const HomePage = () => (
    <section className="max-w-5xl mx-auto px-4 mt-6 grid md:grid-cols-2 gap-6 pb-28">
      <UploadBlock />
      <SummaryBlock />
      <BetslipBlock />
      <AIToolsBlock />
    </section>
  const ScansPage = () => (
    <section className="max-w-5xl mx-auto px-4 mt-6 pb-28">
      <div className="text-white font-semibold text-lg mb-4">Scans</div>
      {scans.length === 0 ? (
        <div className="text-slate-400">No scans yet. Upload an image from Home.</div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
          {scans.map(s => (
            <a key={s.id} href={s.url} target="_blank" rel="noreferrer"
              className="block bg-slate-900/50 rounded-xl overflow-hidden border border-white/5">
              <img src={s.url} alt={s.name} className="w-full h-40 object-cover" />
              <div className="p-3 text-sm text-slate-300 truncate">{s.name}</div>
            </a>
  const EdgePage = () => (
      <div className="flex items-center justify-between">
        <div className="text-white font-semibold text-lg">Edge Assistant</div>
        <div className="flex gap-2">
          <button onClick={() => buildParlay(2)} className="px-3 py-1.5 rounded-lg bg-violet-600 text-white text-sm">Build Safe 2-Leg</button>
          <button onClick={() => buildParlay(3)} className="px-3 py-1.5 rounded-lg bg-slate-800 text-sm hover:bg-slate-700">Build 3-Leg</button>
      {rankedPicks.length === 0 ? (
        <div className="text-slate-400 mt-3">No picks yet. Tap <span className="font-medium text-slate-200">AI Suggest</span> on Home.</div>
        <div className="mt-4 space-y-3">
          {rankedPicks.map((p, i) => (
                  #{i+1} {p.label} <span className="text-slate-400">({(p.prob*100).toFixed(0)}%)</span>
                <div className="text-slate-400 text-sm">
                  {p.league || "Mixed"} • odds {p.odds} • edge {(p.edge*100).toFixed(1)}% • EV {p.ev.toFixed(3)}
                Add
  const HelpPage = () => (
    <section className="max-w-3xl mx-auto px-4 mt-6 pb-28">
      <div className="bg-slate-900/60 border border-white/10 rounded-2xl p-5">
        <div className="text-white font-semibold text-lg mb-2">Help</div>
        <ul className="list-disc pl-5 space-y-2 text-slate-300">
